# Migration `20200505103910-refactor-schema`

This migration has been generated by Tom Barton at 5/5/2020, 10:39:10 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Cart" DROP CONSTRAINT IF EXiSTS "Cart_userId_fkey",
DROP COLUMN "userId",
ADD COLUMN "userId" integer  NOT NULL ;

ALTER TABLE "public"."CartItem" DROP CONSTRAINT IF EXiSTS "CartItem_userId_fkey",
DROP COLUMN "userId";

ALTER TABLE "public"."OrderItem" DROP CONSTRAINT IF EXiSTS "OrderItem_userId_fkey",
DROP COLUMN "userId",
ALTER COLUMN "quantity" DROP DEFAULT;

CREATE UNIQUE INDEX "Cart_userId" ON "public"."Cart"("userId")

ALTER TABLE "public"."Cart" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200505102430-update-cart-schema-for-guest-checkout..20200505103910-refactor-schema
--- datamodel.dml
+++ datamodel.dml
@@ -3,26 +3,24 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("POSTGRESQL_URL")
 }
 model User {
-  email            String      @unique
+  email            String    @unique
   firstname        String
-  id               Int         @default(autoincrement()) @id
+  id               Int       @default(autoincrement()) @id
   lastname         String
   password         String
-  registeredAt     DateTime    @default(now())
-  resetToken       String?     @unique
+  registeredAt     DateTime  @default(now())
+  resetToken       String?   @unique
   resetTokenExpiry DateTime?
-  updatedAt        DateTime    @updatedAt
+  updatedAt        DateTime  @updatedAt
   role             Role
-  cart             CartItem[]
-  OrderItem        OrderItem[]
+  Cart             Cart
   Order            Order[]
-  Cart             Cart[]
 }
 enum Role {
   ADMIN
@@ -42,17 +40,15 @@
   productId String
   quantity  Int     @default(1)
   cart      Cart    @relation(fields: [cardId], references: [id])
   cardId    Int
-  User      User?   @relation(fields: [userId], references: [id])
-  userId    Int?
 }
 model Cart {
   id        Int        @default(autoincrement()) @id
   // User is optional as cart can technically belong to a guest.
-  user      User?      @relation(fields: [userId], references: [id])
-  userId    Int?
+  user      User       @relation(fields: [userId], references: [id])
+  userId    Int
   createdAt DateTime   @default(now())
   CartItem  CartItem[]
 }
@@ -60,11 +56,9 @@
   id       Int    @default(autoincrement()) @id
   title    String
   image    String
   price    Int
-  quantity Int    @default(1)
-  user     User   @relation(fields: [userId], references: [id])
-  userId   Int
+  quantity Int
   Order    Order? @relation(fields: [orderId], references: [id])
   orderId  Int?
 }
```


