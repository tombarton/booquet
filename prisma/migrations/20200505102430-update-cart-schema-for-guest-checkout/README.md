# Migration `20200505102430-update-cart-schema-for-guest-checkout`

This migration has been generated by Tom Barton at 5/5/2020, 10:24:30 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."Cart" (
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "id" SERIAL,
    "userId" integer   ,
    PRIMARY KEY ("id")
) 

ALTER TABLE "public"."CartItem" DROP CONSTRAINT IF EXiSTS "CartItem_userId_fkey",
ADD COLUMN "cardId" integer  NOT NULL ,
ALTER COLUMN "userId" DROP NOT NULL;

ALTER TABLE "public"."Cart" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."CartItem" ADD FOREIGN KEY ("cardId")REFERENCES "public"."Cart"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."CartItem" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200501163612-add-user-to-order-schema..20200505102430-update-cart-schema-for-guest-checkout
--- datamodel.dml
+++ datamodel.dml
@@ -3,9 +3,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("POSTGRESQL_URL")
 }
 model User {
   email            String      @unique
@@ -20,8 +20,9 @@
   role             Role
   cart             CartItem[]
   OrderItem        OrderItem[]
   Order            Order[]
+  Cart             Cart[]
 }
 enum Role {
   ADMIN
@@ -39,12 +40,23 @@
   id        Int     @default(autoincrement()) @id
   product   Product @relation(fields: [productId], references: [id])
   productId String
   quantity  Int     @default(1)
-  user      User    @relation(fields: [userId], references: [id])
-  userId    Int
+  cart      Cart    @relation(fields: [cardId], references: [id])
+  cardId    Int
+  User      User?   @relation(fields: [userId], references: [id])
+  userId    Int?
 }
+model Cart {
+  id        Int        @default(autoincrement()) @id
+  // User is optional as cart can technically belong to a guest.
+  user      User?      @relation(fields: [userId], references: [id])
+  userId    Int?
+  createdAt DateTime   @default(now())
+  CartItem  CartItem[]
+}
+
 model OrderItem {
   id       Int    @default(autoincrement()) @id
   title    String
   image    String
```


