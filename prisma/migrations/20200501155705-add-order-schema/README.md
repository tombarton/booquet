# Migration `20200501155705-add-order-schema`

This migration has been generated by Tom Barton at 5/1/2020, 3:57:05 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "OrderStatus" AS ENUM ('PENDING', 'AWAITING_CONFIRMATION', 'AWAITING_FULFILLMENT', 'FULFILLED');

CREATE TABLE "public"."OrderItem" (
    "id" SERIAL,
    "image" text  NOT NULL ,
    "orderId" integer   ,
    "price" integer  NOT NULL ,
    "quantity" integer  NOT NULL DEFAULT 1,
    "title" text  NOT NULL ,
    "userId" integer  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Order" (
    "chargeId" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "id" SERIAL,
    "status" "OrderStatus" NOT NULL ,
    "total" integer  NOT NULL ,
    "updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id")
) 

ALTER TABLE "public"."Product" DROP COLUMN "price",
ADD COLUMN "price" integer  NOT NULL ;

ALTER TABLE "public"."OrderItem" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."OrderItem" ADD FOREIGN KEY ("orderId")REFERENCES "public"."Order"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200430144156-convert-product-id-to-string..20200501155705-add-order-schema
--- datamodel.dml
+++ datamodel.dml
@@ -3,34 +3,36 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("POSTGRESQL_URL")
 }
 model User {
-  email            String     @unique
+  email            String      @unique
   firstname        String
-  id               Int        @default(autoincrement()) @id
+  id               Int         @default(autoincrement()) @id
   lastname         String
   password         String
-  registeredAt     DateTime   @default(now())
-  resetToken       String?    @unique
+  registeredAt     DateTime    @default(now())
+  resetToken       String?     @unique
   resetTokenExpiry DateTime?
-  updatedAt        DateTime   @updatedAt
+  updatedAt        DateTime    @updatedAt
   role             Role
   cart             CartItem[]
+  OrderItem        OrderItem[]
 }
 enum Role {
   ADMIN
   USER
 }
 model Product {
-  id    String @id
-  name  String
-  price Float
+  id       String     @id
+  name     String
+  price    Int
+  CartItem CartItem[]
 }
 model CartItem {
   id        Int     @default(autoincrement()) @id
@@ -39,4 +41,33 @@
   quantity  Int     @default(1)
   user      User    @relation(fields: [userId], references: [id])
   userId    Int
 }
+
+model OrderItem {
+  id       Int    @default(autoincrement()) @id
+  title    String
+  image    String
+  price    Int
+  quantity Int    @default(1)
+  user     User   @relation(fields: [userId], references: [id])
+  userId   Int
+  Order    Order? @relation(fields: [orderId], references: [id])
+  orderId  Int?
+}
+
+enum OrderStatus {
+  PENDING
+  AWAITING_CONFIRMATION
+  AWAITING_FULFILLMENT
+  FULFILLED
+}
+
+model Order {
+  id        Int         @default(autoincrement()) @id
+  items     OrderItem[]
+  total     Int
+  status    OrderStatus
+  chargeId  String
+  createdAt DateTime    @default(now())
+  updatedAt DateTime    @updatedAt
+}
```


