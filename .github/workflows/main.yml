name: Merge Request

on:
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # - uses: actions/cache@v1
      #   env:
      #     cache-name: cache-node-modules
      #   with:
      #     path: ~/.npm
      #     key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/yarn.lock') }}
      #     restore-keys: |
      #       ${{ runner.os }}-build-${{ env.cache-name }}-
      #       ${{ runner.os }}-build-
      #       ${{ runner.os }}-

      # - name: Install dependencies
      #   run: yarn install

      # - name: Run tests
      #   run: yarn test

      - name: Build, tag and run docker image
        run: |
          docker-compose build
          docker tag booquet/app:latest booquet/app:${{github.sha}}
          docker-compose up -d
        env:
          # A mix of fake and real environment variables, depending on what they do.
          REDIS_HOST: gql-subscriptions
          PRISMA_DB_URL: ${{ secrets.PRISMA_BUILD_URL }}
          JWT_SECRET: hello-world
          BCRYPT_SALT_OR_ROUNDS: 10
          POSTMARK_KEY: hello-world
          CONTENTFUL_MANAGEMENT_TOKEN: hello-world
          CONTENTFUL_ACCESS_TOKEN: hello-world
          CONTENTFUL_SPACE: hello-world
          CONTENTFUL_ENVIRONMENT: staging

      - name: Wait for Docker compose to spin up
        uses: jakejarvis/wait-action@master
        with:
          time: '10s'

      - name: Docker logs
        run: |
          docker ps -a
          docker logs booquet_booquet_1
          curl http://localhost:4000

      - name: Test application
        uses: lakuapik/gh-actions-http-status@v1
        with:
          sites: '["http://localhost:4000/"]'
          expected: '[200]'
